<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShinyWeb - Joieria Online</title>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <link rel="stylesheet" href="estiloo.css">
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-content">
            <div class="logo-title-container">
                <img src="models/logo-shinyweb.png" alt="ShinyWeb Logo" class="header-logo">
                <h1>ShinyWeb</h1>
            </div>
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="Cercar joies...">
            </div>
            <button class="cart-btn" onclick="toggleCart()">
                <span class="cart-text">Cistell</span>
                <span class="cart-count" id="cartCount">0</span>
            </button>
        </div>
    </header>

    <!-- NAVEGACIÓ -->
    <nav>
        <div class="nav-content">
            <button class="nav-btn active" onclick="filterCategory('tots')">
                Tots
            </button>
            <button class="nav-btn" onclick="filterCategory('anells')">
                Anells
            </button>
            <button class="nav-btn" onclick="filterCategory('arracades')">
                Arracades
            </button>
            <button class="nav-btn" onclick="filterCategory('polseres')">
                Polseres
            </button>
        </div>
    </nav>

    <!-- PRODUCTES -->
    <main>
        <div class="products-grid" id="productsGrid"></div>
    </main>

    <!-- MODAL DETALL PRODUCTE -->
    <div class="product-modal" id="productModal" onclick="closeProductModal(event)">
        <div class="product-modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeProductModal()">×</button>
            <div class="product-modal-body">
                <div class="product-modal-3d" id="productModal3D">
                    <!-- AQUÍ SE CARGARÁ EL VISOR 3D INTERACTIVO -->
                </div>
                <div class="product-modal-info">
                    <div class="product-modal-badge">NOU</div>
                    <h2 id="modalProductName" class="modal-product-name"></h2>
                    <p id="modalProductDescription" class="modal-product-description"></p>
                    <div id="modalProductPrice" class="modal-product-price"></div>
                    <div class="modal-product-features">
                        <div class="feature-item">
                            <span class="feature-icon">✓</span>
                            <span>Enviament gratuït</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">✓</span>
                            <span>Garantia de 2 anys</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">✓</span>
                            <span>Certificat d'autenticitat</span>
                        </div>
                    </div>
                    <button class="modal-add-to-cart" id="modalAddToCart">
                        <span class="btn-text">Afegir al Cistell</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CISTELL -->
    <div class="cart-modal" id="cartModal" onclick="closeCartOutside(event)">
        <div class="cart-content" onclick="event.stopPropagation()">
            <div class="cart-header">
                <h2>El Teu Cistell</h2>
                <button class="close-cart" onclick="toggleCart()">×</button>
            </div>
            <div id="cartItems"></div>
            <div class="cart-actions">
                <button class="checkout-btn" onclick="checkout()">
                    Finalitzar Compra
                </button>
                <button class="clear-cart-btn" onclick="clearCart()">
                    Buidar Cistell
                </button>
            </div>
        </div>
    </div>

    <!-- ============= JAVASCRIPT ============= -->
    <script>
        // VERIFICAR QUE THREE.JS Y GLTFLOADER ESTÁN CARGADOS
        console.log('Three.js loaded:', typeof THREE !== 'undefined');
        console.log('GLTFLoader loaded:', typeof THREE.GLTFLoader !== 'undefined');

        // DADES DELS PRODUCTES
        const products = [
            {
                id: 1,
                name: "Anell Diamant",
                category: "anells",
                price: 2500,
                description: "Anell d'or blanc amb diamant natural de 0.5 quilats. Disseny clàssic i elegant.",
                model: "models/pendientes1.glb"
            },
            {
                id: 2,
                name: "Anell Safir",
                category: "anells",
                price: 1800,
                description: "Anell amb safir blau autèntic envoltat de diamants petits. Estil vintage.",
                model: null
            },
            {
                id: 3,
                name: "Arracades Diamant",
                category: "arracades",
                price: 3200,
                description: "Arracades de penjoll amb diamants naturals. Perfectes per ocasions especials.",
                model: null
            },
            {
                id: 4,
                name: "Arracades Perla",
                category: "arracades",
                price: 1500,
                description: "Arracades amb perles cultivades d'aigua dolça. Elegància atemporal.",
                model: null
            },
            {
                id: 5,
                name: "Polsera Tennis",
                category: "polseres",
                price: 4500,
                description: "Polsera Tennis amb diamants de talla brillant. Luxe incomparable.",
                model: null
            },
            {
                id: 6,
                name: "Polsera Charm",
                category: "polseres",
                price: 980,
                description: "Polsera d'or de 18 quilats amb charms personalitzables. Estil modern.",
                model: null
            }
        ];

        // ESTAT (en memòria)
        let cart = [];
        let currentCategory = 'tots';
        let searchQuery = '';
        let currentProductId = null;
        let activeScene = null;

        // ============= CREAR VISOR 3D - VISTA PREVIA (TARGETES) =============
        function create3DPreview(productId, container) {
            const product = products.find(p => p.id === productId);
            
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xFFFBF7);

            const camera = new THREE.PerspectiveCamera(
                45, 
                container.clientWidth / container.clientHeight, 
                0.1, 
                1000
            );
            camera.position.set(0, 0, 5);

            const renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true,
                preserveDrawingBuffer: true
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;  // 👈 PRESERVAR COLORES
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            container.appendChild(renderer.domElement);

            // Llums mejoradas
            const light1 = new THREE.DirectionalLight(0xffffff, 1.5);
            light1.position.set(5, 5, 5);
            scene.add(light1);

            const light2 = new THREE.DirectionalLight(0xffffff, 0.8);
            light2.position.set(-5, -5, -5);
            scene.add(light2);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            if (!product.model || typeof THREE.GLTFLoader === 'undefined') {
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xD4C5A9,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const fallbackModel = new THREE.Mesh(geometry, material);
                scene.add(fallbackModel);
                
                function animate() {
                    requestAnimationFrame(animate);
                    fallbackModel.rotation.y += 0.005;
                    renderer.render(scene, camera);
                }
                animate();
                return;
            }

            const loader = new THREE.GLTFLoader();
            loader.load(
                product.model,
                function(gltf) {
                    const model = gltf.scene;
                    model.scale.set(2, 2, 2);
                    
                    // PRESERVAR MATERIALES Y TEXTURAS
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // NO modificar el material, mantener el original
                            if (child.material) {
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    // Ajustar tamaño SIN perder calidad
                    model.scale.set(0.8, 0.8, 0.8);
                    
                    // Centra el model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    model.position.sub(center);
                    
                    scene.add(model);
                    
                    function animate() {
                        requestAnimationFrame(animate);
                        model.rotation.y += 0.005;
                        renderer.render(scene, camera);
                    }
                    animate();
                },
                undefined,
                function(error) {
                    console.error('Error cargando modelo:', error);
                    const geometry = new THREE.SphereGeometry(1, 32, 32);
                    const material = new THREE.MeshStandardMaterial({ 
                        color: 0xFF6B6B,
                        metalness: 0.7,
                        roughness: 0.3
                    });
                    const fallbackModel = new THREE.Mesh(geometry, material);
                    scene.add(fallbackModel);
                    
                    function animate() {
                        requestAnimationFrame(animate);
                        fallbackModel.rotation.y += 0.005;
                        renderer.render(scene, camera);
                    }
                    animate();
                }
            );
        }

        // ============= CREAR VISOR 3D INTERACTIU (MODAL) =============
        function create3DInteractiveViewer(productId, container) {
            container.innerHTML = '';
            
            const product = products.find(p => p.id === productId);
            
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xFFFBF7);

            const camera = new THREE.PerspectiveCamera(
                50, 
                container.clientWidth / container.clientHeight, 
                0.1, 
                1000
            );
            camera.position.set(0, 0, 6);

            const renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true,
                preserveDrawingBuffer: true
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;  // 👈 PRESERVAR COLORES
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            container.appendChild(renderer.domElement);

            // Llums mejoradas
            const light1 = new THREE.DirectionalLight(0xffffff, 1.8);
            light1.position.set(8, 8, 8);
            scene.add(light1);

            const light2 = new THREE.DirectionalLight(0xffffff, 1.0);
            light2.position.set(-5, 5, -5);
            scene.add(light2);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);

            if (!product.model || typeof THREE.GLTFLoader === 'undefined') {
                const geometry = new THREE.SphereGeometry(1.5, 32, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xD4C5A9,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const model = new THREE.Mesh(geometry, material);
                scene.add(model);

                let isDragging = false;
                let previousMouseX = 0;
                let previousMouseY = 0;
                
                renderer.domElement.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    previousMouseX = e.clientX;
                    previousMouseY = e.clientY;
                });
                
                renderer.domElement.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const deltaX = e.clientX - previousMouseX;
                        const deltaY = e.clientY - previousMouseY;
                        model.rotation.y += deltaX * 0.01;
                        model.rotation.x += deltaY * 0.01;
                        previousMouseX = e.clientX;
                        previousMouseY = e.clientY;
                    }
                });
                
                renderer.domElement.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                function animate() {
                    if (!isDragging) {
                        model.rotation.y += 0.003;
                    }
                    renderer.render(scene, camera);
                    requestAnimationFrame(animate);
                }
                animate();
                
                activeScene = { scene, renderer };
                return;
            }

            const loader = new THREE.GLTFLoader();
            loader.load(
                product.model,
                function(gltf) {
                    const model = gltf.scene;
                    model.scale.set(3, 3, 3);
                    
                    // PRESERVAR MATERIALES Y TEXTURAS
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // NO modificar el material, mantener el original
                            if (child.material) {
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    // Ajustar tamaño SIN perder calidad
                    model.scale.set(1.2, 1.2, 1.2);
                    
                    // Centra el model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    model.position.sub(center);
                    
                    scene.add(model);
                    
                    let isDragging = false;
                    let previousMouseX = 0;
                    let previousMouseY = 0;
                    
                    renderer.domElement.addEventListener('mousedown', (e) => {
                        isDragging = true;
                        previousMouseX = e.clientX;
                        previousMouseY = e.clientY;
                    });
                    
                    renderer.domElement.addEventListener('mousemove', (e) => {
                        if (isDragging) {
                            const deltaX = e.clientX - previousMouseX;
                            const deltaY = e.clientY - previousMouseY;
                            
                            model.rotation.y += deltaX * 0.01;
                            model.rotation.x += deltaY * 0.01;
                            
                            previousMouseX = e.clientX;
                            previousMouseY = e.clientY;
                        }
                    });
                    
                    renderer.domElement.addEventListener('mouseup', () => {
                        isDragging = false;
                    });
                    
                    renderer.domElement.addEventListener('mouseleave', () => {
                        isDragging = false;
                    });
                    
                    function animate() {
                        if (!isDragging) {
                            model.rotation.y += 0.003;
                        }
                        renderer.render(scene, camera);
                        requestAnimationFrame(animate);
                    }
                    animate();
                },
                undefined,
                function(error) {
                    console.error('Error en modal:', error);
                }
            );

            activeScene = { scene, renderer };
        }

        // ============= OBRIR MODAL PRODUCTE =============
        function openProductDetail(productId) {
            currentProductId = productId;
            const product = products.find(p => p.id === productId);
            
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductDescription').textContent = product.description;
            document.getElementById('modalProductPrice').textContent = product.price + '€';
            
            const addButton = document.getElementById('modalAddToCart');
            addButton.onclick = () => addToCartFromModal(productId);
            
            document.getElementById('productModal').classList.add('active');
            
            setTimeout(() => {
                const container = document.getElementById('productModal3D');
                create3DInteractiveViewer(productId, container);
            }, 100);
        }

        // ============= TANCAR MODAL PRODUCTE =============
        function closeProductModal(event) {
            if (event && event.target.className !== 'product-modal') return;
            
            document.getElementById('productModal').classList.remove('active');
            currentProductId = null;
            
            if (activeScene) {
                const container = document.getElementById('productModal3D');
                container.innerHTML = '';
                activeScene = null;
            }
        }

        // ============= RENDERITZAR PRODUCTES =============
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            let filtered = products;

            if (currentCategory !== 'tots') {
                filtered = filtered.filter(p => p.category === currentCategory);
            }

            if (searchQuery) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    p.description.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="no-results">No hi ha productes</div>';
                return;
            }

            filtered.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => openProductDetail(product.id);
                card.innerHTML = `
                    <div class="product-3d" id="viewer-${product.id}"></div>
                    <div class="product-badge">NOU</div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price}€</div>
                        <div class="product-click-hint">Click per veure detalls</div>
                    </div>
                `;
                grid.appendChild(card);

                setTimeout(() => {
                    const container = document.getElementById(`viewer-${product.id}`);
                    if (container) create3DPreview(product.id, container);
                }, 100);
            });
        }

        // ============= FILTRES =============
        function filterCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.nav-btn').classList.add('active');
            renderProducts();
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderProducts();
        });

        // ============= CISTELL =============
        function addToCartFromModal(productId) {
            const product = products.find(p => p.id === productId);
            cart.push(product);
            updateCartCount();
            
            const button = document.getElementById('modalAddToCart');
            button.innerHTML = '<span class="btn-text">Afegit!</span>';
            button.classList.add('added');
            
            setTimeout(() => {
                button.innerHTML = '<span class="btn-text">Afegir al Cistell</span>';
                button.classList.remove('added');
            }, 1500);
            
            const cartCount = document.getElementById('cartCount');
            cartCount.classList.add('bump');
            setTimeout(() => cartCount.classList.remove('bump'), 300);
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        function toggleCart() {
            document.getElementById('cartModal').classList.toggle('active');
            renderCart();
        }

        function closeCartOutside(event) {
            if (event.target.id === 'cartModal') {
                toggleCart();
            }
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-text">El cistell està buit</div>
                        <div class="empty-cart-subtext">Afegeix alguns productes per començar</div>
                    </div>
                `;
                return;
            }

            let total = 0;
            let html = '<div class="cart-items-list">';

            cart.forEach((item, index) => {
                total += item.price;
                html += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${item.price}€</div>
                        </div>
                        <button class="remove-item" onclick="removeFromCart(${index})" title="Eliminar">
                            ×
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            html += `
                <div class="cart-summary">
                    <div class="cart-summary-row">
                        <span>Subtotal:</span>
                        <span>${total}€</span>
                    </div>
                    <div class="cart-summary-row">
                        <span>Enviament:</span>
                        <span class="free">GRATUÏT</span>
                    </div>
                    <div class="cart-total">
                        <span>Total:</span>
                        <span>${total}€</span>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartCount();
            renderCart();
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('Estàs segur que vols buidar el cistell?')) {
                cart = [];
                updateCartCount();
                renderCart();
            }
        }

        function checkout() {
            if (cart.length === 0) {
                alert('El cistell està buit!');
                return;
            }
            alert('Redirigint a la pàgina de pagament...');
        }

        // INICIAR
        renderProducts();
    </script>
</body>
</html>
